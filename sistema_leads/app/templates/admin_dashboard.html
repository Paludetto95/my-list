{% extends "base.html" %}

{% block content %}
<style>
    .progress-bar-wrapper {
        display: flex;
        height: 25px;
        background-color: #e9ecef; /* Cinza para os leads disponíveis */
        border-radius: .25rem;
        font-size: 12px;
        font-weight: bold;
        color: white;
    }
    .progress-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        transition: width 0.5s ease-in-out;
        white-space: nowrap;
        overflow: hidden;
    }
    .progress-tabulated { background-color: #28a745; } /* Verde para tabulados */
    .progress-in-progress { background-color: #ffc107; } /* Amarelo para em atendimento */
</style>

<div class="container">
    <h2 class="mb-4">Painel do Administrador</h2>

    <!-- NOVA BARRA DE PROGRESSO EMPILHADA -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    Visão Geral da Base de Leads (Total: {{ chart_data.total }})
                </div>
                <div class="card-body">
                    {% if chart_data.total > 0 %}
                        {% set tabulated_percent = (chart_data.tabulated / chart_data.total) * 100 %}
                        {% set in_progress_percent = (chart_data.in_progress / chart_data.total) * 100 %}
                        
                        <div class="progress-bar-wrapper" data-toggle="tooltip" data-placement="top" title="Progresso da Base de Leads">
                            <div class="progress-segment progress-tabulated" style="width: {{ tabulated_percent }}%;">
                                {% if tabulated_percent > 5 %}{{ "%.0f"|format(tabulated_percent) }}%{% endif %}
                            </div>
                            <div class="progress-segment progress-in-progress" style="width: {{ in_progress_percent }}%;">
                                {% if in_progress_percent > 5 %}{{ "%.0f"|format(in_progress_percent) }}%{% endif %}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 text-muted small">
                            <span><span style="display:inline-block; width:12px; height:12px; background-color:#28a745; border-radius:3px; margin-right: 5px;"></span>Tabulados: {{ chart_data.tabulated }}</span>
                            <span><span style="display:inline-block; width:12px; height:12px; background-color:#ffc107; border-radius:3px; margin-right: 5px;"></span>Em Atendimento: {{ chart_data.in_progress }}</span>
                            <span><span style="display:inline-block; width:12px; height:12px; background-color:#e9ecef; border-radius:3px; margin-right: 5px;"></span>Disponíveis: {{ chart_data.available }}</span>
                        </div>
                    {% else %}
                        <p class="text-muted">Ainda não há leads na base de dados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Menu de Abas -->
    <ul class="nav nav-tabs" id="adminTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link" id="report-tab" data-toggle="tab" href="#report" role="tab" aria-controls="report" aria-selected="true">Relatório do Dia</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="all-leads-tab" data-toggle="tab" href="#all-leads" role="tab" aria-controls="all-leads" aria-selected="false">Base Geral de Leads</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="management-tab" data-toggle="tab" href="#management" role="tab" aria-controls="management" aria-selected="false">Gestão</a>
        </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="adminTabContent">
        
        <!-- Aba: Relatório do Dia -->
        <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
            <div class="card card-body border-top-0">
                <h4 class="mb-3">Leads Tabulados Hoje</h4>
                <form method="GET" action="{{ url_for('main.admin_dashboard') }}" class="mb-4">
                    <input type="hidden" name="tab" value="report">
                    <div class="form-row">
                        <div class="col-md-5">
                            <input type="text" name="q" class="form-control" placeholder="Buscar por nome, CPF ou consultor..." value="{{ search_query or '' }}">
                        </div>
                        <div class="col-md-5">
                            <select name="tabulation_filter" class="form-control">
                                <option value="">Filtrar por tabulação...</option>
                                {% for tab in all_tabulations %}
                                    <option value="{{ tab.id }}" {% if tabulation_filter == tab.id|string %}selected{% endif %}>{{ tab.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-block">Filtrar</button>
                        </div>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Cliente</th>
                                <th>Consultor</th>
                                <th>Tabulação</th>
                                <th>Horário</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in todays_tabulations.items %}
                            <tr>
                                <td>{{ lead.nome_cliente }}</td>
                                <td>{{ lead.consultor.username if lead.consultor else 'N/A' }}</td>
                                <td>
                                    {% if lead.tabulation %}
                                    <span class="badge" style="background-color: {{ lead.tabulation.color }}; color: white;">
                                        {{ lead.tabulation.name }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.data_tabulacao.strftime('%H:%M:%S') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">Nenhum lead encontrado com os filtros atuais.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if todays_tabulations.pages > 1 %}
                <nav>
                    <ul class="pagination justify-content-center">
                        {% for page_num in todays_tabulations.iter_pages() %}
                            {% if page_num %}
                                <li class="page-item {% if todays_tabulations.page == page_num %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page_today=page_num, q=search_query, tabulation_filter=tabulation_filter, tab='report') }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>

        <!-- Aba: Base Geral de Leads -->
        <div class="tab-pane fade" id="all-leads" role="tabpanel" aria-labelledby="all-leads-tab">
            <div class="card card-body border-top-0">
                <h4 class="mb-3">Todos os Leads no Sistema</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>CPF</th>
                                <th>Status</th>
                                <th>Consultor</th>
                                <th>Tabulação Final</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in all_leads.items %}
                            <tr>
                                <td>{{ lead.id }}</td>
                                <td>{{ lead.nome_cliente }}</td>
                                <td>{{ lead.cpf }}</td>
                                <td><span class="badge badge-pill badge-info">{{ lead.status }}</span></td>
                                <td>{{ lead.consultor.username if lead.consultor else 'Não atribuído' }}</td>
                                <td>
                                    {% if lead.tabulation %}
                                        <span class="badge" style="background-color: {{ lead.tabulation.color }}; color: white;">{{ lead.tabulation.name }}</span>
                                    {% else %}
                                        <span class="badge badge-light">Pendente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">Nenhum lead encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if all_leads.pages > 1 %}
                <nav>
                    <ul class="pagination justify-content-center">
                        {% for page_num in all_leads.iter_pages() %}
                            {% if page_num %}
                                <li class="page-item {% if all_leads.page == page_num %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page_all=page_num, tab='all-leads') }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>

        <!-- Aba: Gestão -->
        <div class="tab-pane fade" id="management" role="tabpanel" aria-labelledby="management-tab">
            <div class="card card-body border-top-0">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Gestão de Utilizadores</h5>
                                <p class="card-text">Crie, edite e elimine contas de utilizadores.</p>
                                <a href="{{ url_for('main.manage_users') }}" class="btn btn-primary">Gerir Utilizadores</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Gestão de Tabulações</h5>
                                <p class="card-text">Crie os status para a tabulação dos leads.</p>
                                <a href="{{ url_for('main.manage_tabulations') }}" class="btn btn-secondary">Gerir Tabulações</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                             <div class="card-body">
                                <h5 class="card-title">Importar Leads</h5>
                                <p class="card-text">Suba uma nova lista de leads para a base geral.</p>
                                <form action="{{ url_for('main.upload_file') }}" method="POST" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <input type="file" class="form-control-file" name="file" id="file" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Enviar Arquivo</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- SCRIPT PARA MANTER A ABA ATIVA -->
<script>
    $(document).ready(function() {
        // Lógica para manter a aba ativa
        let urlParams = new URLSearchParams(window.location.search);
        let tab = urlParams.get('tab');
        if (tab) {
            $('#adminTab a[href="#' + tab + '"]').tab('show');
        } else {
            $('#adminTab a[href="#report"]').tab('show');
        }
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            let targetTab = $(e.target).attr("href").substring(1);
            let url = new URL(window.location);
            url.searchParams.set("tab", targetTab);
            url.searchParams.delete("page_all");
            url.searchParams.delete("page_today");
            window.history.replaceState({}, '', url);
        });
    });
</script>
{% endblock %}
